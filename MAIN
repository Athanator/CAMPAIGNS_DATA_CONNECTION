SELECT DISTINCT    



       WH.AC_REGISTR AS REG,
       SUBSTR(
          DH.ATA_CHAPTER,
          1,
          2
       ) AS ATA,
	   
	   
	   
(SELECT DISTINCT

CASE
WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'AD') IS NOT NULL  THEN 
(SELECT DISTINCT DH8.DOCNO FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'AD')

WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'AD') IS NULL AND  DH3.DOCNO IS NOT NULL THEN DH3.DOCNO

ELSE DH4.DOCNO
END AS PROVA

FROM "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST1

LEFT JOIN "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST2 ON DST2.DOCNO_I IN(DST1.DOCNO_I, DST1.REF_DOCNO_I)
LEFT JOIN "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST3 ON DST3.REF_DOCNO_I = DST2.DOCNO_I
LEFT JOIN "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST4 ON DST4.REF_DOCNO_I = DST3.DOCNO_I

LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH1 ON DH1.DOCNO_I = DST1.REF_DOCNO_I
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH2 ON DH2.DOCNO_I = DST2.DOCNO_I AND DH2.DOC_TYPE = 'AD'
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH3 ON DH3.DOCNO_I = DST3.DOCNO_I AND DH3.DOC_TYPE = 'AD'
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH4 ON DH4.DOCNO_I = DST4.DOCNO_I AND DH4.DOC_TYPE = 'AD'

WHERE DH1.DOCNO_I = DH.DOCNO_I AND ROWNUM = 1 AND CASE
WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'AD') IS NOT NULL  THEN 
(SELECT DISTINCT DH8.DOCNO FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'AD')

WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8  WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'AD') IS NULL AND  DH3.DOCNO IS NOT NULL THEN DH3.DOCNO

ELSE DH4.DOCNO
END IS NOT NULL




) AS AD,

(SELECT DISTINCT
CASE
WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'MA%') IS NOT NULL  THEN 
(SELECT DISTINCT DH8.DOCNO FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'MA%')

WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'MA%') IS NULL  THEN DH3.DOCNO

ELSE DH4.DOCNO
END AS PROVA

FROM "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST1

LEFT JOIN "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST2 ON DST2.DOCNO_I IN(DST1.DOCNO_I, DST1.REF_DOCNO_I)
LEFT JOIN "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST3 ON DST3.REF_DOCNO_I = DST2.DOCNO_I
LEFT JOIN "AMOSSERVER_PROD"."DOC_SIGNOFF_TREE" DST4 ON DST4.REF_DOCNO_I = DST3.DOCNO_I

LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH1 ON DH1.DOCNO_I = DST1.REF_DOCNO_I
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH2 ON DH2.DOCNO_I = DST2.DOCNO_I AND DH2.DOC_TYPE = 'MA'
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH3 ON DH3.DOCNO_I = DST3.DOCNO_I AND DH3.DOC_TYPE = 'MA'
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH4 ON DH4.DOCNO_I = DST4.DOCNO_I AND DH4.DOC_TYPE = 'MA'

WHERE DH1.DOCNO_I = DH.DOCNO_I AND 


CASE
WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'MA%') IS NOT NULL  THEN 
(SELECT DISTINCT DH8.DOCNO FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'MA%')

WHEN (SELECT DISTINCT DH8.DOC_TYPE FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8 WHERE DH8.DOCNO_I = DST1.DOCNO_I AND DH8.DOC_TYPE LIKE 'MA%') IS NULL  THEN DH3.DOCNO

ELSE DH4.DOCNO
END IS NOT NULL



) AS MA,
       DH.DOC_TYPE,
       DH.DOCNO AS DOCUMENT,
       DH.REVISION AS REV,

   CASE WHEN DH.DOC_TYPE LIKE '%AD%' 
       OR F.PRIO = '1' 
       OR DH.DOCNO IN(
          '34-1712',
          '34-1720',
          '34-1630',
          '31-1450',
          '34-1744',
          '34-1663',
          '31-1353',
          '31-1357',
          '46-1095',
          '46-1121'
       ) THEN 'TECH. SERV. (AD)'  
WHEN D.DESCRIPTION  LIKE '%TECH. SERVICES - EASA AD/MANDATE%' THEN 'TECH. SERV. (AD)'
WHEN D.DESCRIPTION  LIKE '%TECHNICAL SERVICES%' THEN 'TECH. SERV. (REC)'
ELSE D.DESCRIPTION 

END AS SOURCE,

CASE
WHEN DH.DOCNO = 'AED2019-47M' THEN 'MODIFICATION OF EEL ON A320 CEO'
WHEN DH.DOCNO = '4611-401-01' THEN 'MODIFICATION OF EFB HOLDER'
WHEN DH.DOCNO = '31-1450' THEN 'MODIFICATION OF SDAC TO H2-F4'
WHEN DH.DOCNO = '34-1630' THEN 'ACTIVATION OF ATC ADSB-OUT'
WHEN DH.DOCNO = '34-1712' THEN 'INSTALLATION OF ATC ACSS ADS-B'
WHEN DH.DOCNO = '34-1744' THEN 'INSTALLTION OF WIRING ATC ADS-B'
WHEN DH.DOCNO = '27-1273' THEN 'INSPECTION OF RUDDER SERVO FOR MISSING LOCKWIRE'
WHEN DH.DOCNO = '780085-EO-103 PART 1' THEN 'INSTALLATION OF FWD CARGO FLOOR (CARGOTEK)'
WHEN DH.DOCNO = '780085-EO-104 PART 1' THEN 'INSTALLATION OF AFT CARGO FLOOR (CARGOTEK)'
WHEN DH.DOCNO = '21-1217' THEN 'MODIFICATION OF AEVC (V .07)'
WHEN DH.DOCNO = '63253213BC-588-01' THEN 'WIFI: BMU SW DROP 3 UPGRADE'
WHEN DH.DOCNO = '01576-IST-B-SRB' THEN 'WIFI: ORT FILE 63AA UPGRADE'
WHEN DH.DOCNO = '32-1470' THEN 'MODIFICATION OF ACC. PRE-CHARGE PRESSURE (CEO)'
WHEN DH.DOCNO = '53-1270' THEN 'MODIFICATION OF FASTENER HOLE OF FRAME FEET COUPLING'
WHEN DH.DOCNO = '2270-301-06' THEN 'UPGRADE OF FMGC SOFTWARE (S7BI15)'
WHEN DH.DOCNO = 'SCA-01076-SB-S06' THEN 'WIFI: SDU SW-4000-7'
WHEN DH.DOCNO = '3342-401-01' THEN 'REPLACEMENT OF LANDING LIGHT'
WHEN DH.DOCNO = '01598-IST-A-SRB' THEN 'WIFI: 2000VU STICKERS MODIFICATION'
WHEN DH.DOCNO = 'AZQ01-53AB-EI-002' THEN 'INSTALLATION OF LF-ULD A320 - VLG'
WHEN DH.DOCNO = '2234440-170' THEN 'INSTALLATION OF WQAR '
WHEN DH.DOCNO = '2234440-173' THEN 'INSTALLATION OF WQAR '
WHEN DH.DOCNO = '54-1036' THEN 'MODIFICATION OF PYLONS AFT FIXED FAIRING'
WHEN DH.DOCNO = '27-1245' THEN 'INSTALLATION PROVISIONS FOR ELSD'
WHEN DH.DOCNO = '27-1247' THEN 'MODIFICATION OF THSA WITH ELSD'
WHEN DH.DOCNO = '27-1248' THEN 'ACTIVATION OF ELSD ON SA THSA'
WHEN DH.DOCNO = '2270-301-05' THEN 'UPGRADE OF FMGC SOFTWARE (S7BC14)'
WHEN DH.DOCNO = '32-1444' THEN 'REPLACEMENT OF 62GA RELAY'
WHEN DH.DOCNO = 'AVI-02080-SB' THEN 'HEADSETS: MODIFICATION OF A/C CONNECTOR'
WHEN DH.DOCNO = 'PW1000G-C-75-00-0023-00A-930A-D' THEN 'INSPECTION OF TCC AIR VALVE ON PW ENG'
WHEN DH.DOCNO = '2793-301-01' THEN 'UPGRADE OF ELAC SW (L103+) ON A320 NEO'
WHEN DH.DOCNO = '73-1138' THEN 'UPGRADE OF EEC (SCN23/AC) SW ON IAE ENGINES'
WHEN DH.DOCNO = '112F-21' THEN 'ENGINE REPLACEMENT FOR IN-SHOP INSPECTION (V2500)'
WHEN DH.DOCNO = 'SCA-01076-SB-S07' THEN 'WIFI: REPLACEMENT OF MSS ANTENNA'
WHEN DH.DOCNO = '54-1048' THEN 'REMOVAL OF FLAP-DOOR OF THE PRECOOLER EXHAUST'
WHEN DH.DOCNO = 'GRAA320NEO-A-29-11-0004-00001-930AD' THEN 'INSPECTION OF HYDRAULIC SUCTION HOSE ON PW ENGINES'
WHEN DH.DOCNO = '01621-IST-A-SRB' THEN 'INSPECTION OF WIFI SERVER TRAY'
WHEN DH.DOCNO = '780085-EO-302' THEN 'INSTALLATION OF AFT CARGO FLOOR (CARGOTEK)'
WHEN DH.DOCNO = '780085-EO-501' THEN 'INSTALLATION OF FWD CARGO FLOOR (CARGOTEK)'
WHEN DH.DOCNO = '780085-EO-502' THEN 'INSTALLATION OF AFT CARGO FLOOR (CARGOTEK)'
WHEN DH.DOCNO = '53-1337' THEN 'MODIFICATION OF STIFFENER ON RHS FRAME'
WHEN DH.DOCNO = '53-1338' THEN 'MODIFICATION OF STIFFENER ON LHS FRAME'
WHEN DH.DOCNO = '3136-201-06' THEN 'UPGRADE OF WQAR SOFTWARE (MOVISTAR)'
WHEN DH.DOCNO = '53-1406' THEN 'MODIFICATION OF VERTICAL STIFFENER ON RH FRAME'
WHEN DH.DOCNO = '53-1407' THEN 'MODIFICATION OF VERTICAL STIFFENER ON LH FRAME'
WHEN DH.DOCNO = '2351-401-01' THEN 'REPLACEMENT OF HEADSETS'
WHEN DH.DOCNO = '49-1107' THEN 'MODIFICATION OF APU ECB'
WHEN DH.DOCNO = 'RA32071-164' THEN 'REPLACEMENT OF AFT ENG MOUNT RETAINER'
WHEN DH.DOCNO = '27-1286' THEN 'INSTALLATION OF PROTECTION ON THS CTRL CABLES (CEO)'
WHEN DH.DOCNO = '53-1262' THEN 'MODIFICATION AT SECTION 16-17 AND 18'
WHEN DH.DOCNO = '36-1084' THEN 'MODIFICATION OF DIFFERENTIAL PRESSURE SENSOR (DPS)'
WHEN DH.DOCNO = '53-1269' THEN 'INSPECTION OF FRAME FOOT AT FR43 RH/LH'
WHEN DH.DOCNO = '71-1066-AD PART' THEN 'INSPECTION OF FWD ENGINE MOUNT SNOUT'
WHEN DH.DOCNO = '71-1065-AD PART' THEN 'MODIFICATION OF FWD ENGINE MOUNT SNOUT'
WHEN DH.DOCNO = '32-1473' THEN 'INSPECTION OF MLG DAMPER UNIT'

ELSE CONCAT (
          DH.TEXT,
          DH.TEXT2        
       ) 

END AS SUBJECT,

       WH.WORKORDERNO_DISPLAY AS WORKORDER,
(SELECT DISTINCT



CASE
WHEN (SELECT DISTINCT


TREQ_I.DIMENSION_TYPE

FROM "AMOSSERVER_PROD"."DOC_HEADER" DH1

INNER JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY_LINK" EEL ON  EEL.EVENT_TYPE='DO' AND EEL.EVENT_KEY = DH1.DOCNO_I 
INNER JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY" EE ON EEL.EFFECTIVITYNO_I = EE.EFFECTIVITYNO_I 
INNER JOIN (SELECT DISTINCT ME.REVISION_KEY, ME.REVISION_TYPE, ME.APPLICABLE_STATUS, ME.TIMEREQUIREMENTNO_I FROM     "AMOSSERVER_PROD"."MEVT_EFFECTIVITY" ME) ME2 ON 
EEL.EVENT_KEY = ME2.REVISION_KEY AND ME2.REVISION_TYPE = 'DO'

INNER JOIN "AMOSSERVER_PROD"."TREQ_TIME_REQUIREMENT" TREQ_TR ON ME2.TIMEREQUIREMENTNO_I = TREQ_TR.TIMEREQUIREMENTNO_I 

INNER JOIN "AMOSSERVER_PROD"."TREQ_INTERVAL_GROUP" TREQ_IG ON TREQ_TR.TIMEREQUIREMENTNO_I = TREQ_IG.TIMEREQUIREMENTNO_I 

LEFT JOIN "AMOSSERVER_PROD"."TREQ_DIMENSION_GROUP" TREQ_DG ON TREQ_IG.INTERVAL_GROUPNO_I = TREQ_DG.INTERVAL_GROUPNO_I

LEFT JOIN "AMOSSERVER_PROD"."TREQ_INTERVAL" TREQ_I ON TREQ_DG.DIMENSION_GROUPNO_I = TREQ_I.DIMENSION_GROUPNO_I

WHERE DH1.DOCNO_I =  DH8.DOCNO_I AND TREQ_I.DIMENSION_TYPE = 'I')  = 'I' THEN 'Y'

ELSE 'N'

END AS REPETITVE

FROM "AMOSSERVER_PROD"."DOC_HEADER" DH8



WHERE DH8.DOCNO_I = DH.DOCNO_I) AS REP_DOC,



CASE
WHEN DHM.IMP_OCCASION = 'L' THEN 'LINE'
WHEN DHM.IMP_OCCASION = 'H' THEN 'HEAVY'
WHEN DHM.IMP_OCCASION = 'S' THEN 'SPECIAL'
WHEN DHM.IMP_OCCASION = 'R' THEN 'INFO'
WHEN DHM.IMP_OCCASION = 'O' THEN 'HEAVY/SPECIAL'

ELSE 'HEAVY/LINE'

END AS LINE_OR_HEAVY,
       CASE        WHEN WEL.EVENT_STATUS = 'O' 
       AND WH.CLOSING_DATE IS NULL THEN 'OPEN' WHEN WEL.EVENT_STATUS = 'Y' 
       AND WH.CLOSING_DATE IS NULL THEN 'OPEN' 	       WHEN WEL.EVENT_STATUS = 'O' 
       AND WH.CLOSING_DATE IS NOT NULL THEN 'CLOSED'  WHEN WEL.EVENT_STATUS = 'Y' 
       AND WH.CLOSING_DATE IS NOT NULL THEN 'CLOSED'  WHEN WEL.EVENT_STATUS = 'V' THEN 'CLOSED'  END AS STATUS,

       WH.CLOSING_DATE,
      
CASE
WHEN  (SELECT*

FROM (SELECT WT2.ABSOLUTE_DUE_DATE FROM "AMOSSERVER_PROD"."WO_TRANSFER" WT2


 WHERE WT2.TRANSFER_TYPE IN('O','T') AND WH.AC_REGISTR = A.AC_REGISTR AND WEL.EVENT_PERFNO_I = WT2.EVENT_PERFNO_I AND WEL.EVENT_KEY_PARENT = DH.DOCNO_I  

ORDER BY WT2.EVENT_TRANSFERNO_I DESC ) WHERE ROWNUM = 1   )   IS NULL THEN F.EXPECTED_DATE

ELSE  (SELECT*

FROM (SELECT WT2.ABSOLUTE_DUE_DATE FROM "AMOSSERVER_PROD"."WO_TRANSFER" WT2


 WHERE WT2.TRANSFER_TYPE IN('O','T') AND WH.AC_REGISTR = A.AC_REGISTR AND WEL.EVENT_PERFNO_I = WT2.EVENT_PERFNO_I 
 AND WEL.EVENT_KEY_PARENT = DH.DOCNO_I  

ORDER BY WT2.EVENT_TRANSFERNO_I DESC ) WHERE ROWNUM = 1   )

END AS DUE_DATE,


       DHM.LABOUR_COST*DHM.EST_MH + DHM.MATERIAL_COST AS COST_PER_AC,
       
	   SUM(
          CASE  WHEN F.EXPECTED_DATE IS NOT NULL AND WH.CLOSING_DATE IS NULL AND F.EVENT_TYPE = 'D'
           THEN 1 ELSE 0 END
       ) OVER (PARTITION BY  DH.DOCNO) AS PENDING,

 

(SELECT DISTINCT


COUNT(DISTINCT CONCAT(A2.AC_REGISTR,R2.PSN)) 


FROM "AMOSSERVER_PROD"."DOC_HEADER" DH2

INNER JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY_LINK" EEL2 ON  EEL2.EVENT_TYPE= 'DO' AND EEL2.EVENT_KEY = DH2.DOCNO_I 
INNER JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY" EE ON EEL2.EFFECTIVITYNO_I = EE.EFFECTIVITYNO_I 
INNER JOIN "AMOSSERVER_PROD"."APPLICABILITY" AP ON AP.EFFECTIVITYNO_I = EE.EFFECTIVITYNO_I AND AP.REF_TYPE IN('RO','AC_INT')
LEFT JOIN "AMOSSERVER_PROD"."AIRCRAFT" A2 ON AP.REF_KEY = A2.AIRCRAFTNO_I
LEFT JOIN "AMOSSERVER_PROD"."ROTABLES" R2 ON AP.REF_KEY =  R2.PSN 

WHERE AP.APPLICABLE = 'Y' AND DH2.DOCNO_I = DH.DOCNO_I) AS TOTAL,

MIN(WEL.CREATED_DATE) OVER (PARTITION BY DH.DOCNO_I) AS RELEASE_DATE,

MIN(WH.CLOSING_DATE) OVER (PARTITION BY DH.DOCNO_I) AS START_DATE,

(SELECT DISTINCT
CASE
WHEN (SUM(
          CASE  WHEN F1.EXPECTED_DATE IS NOT NULL  AND F1.EVENT_TYPE = 'D' AND WEL1.PENDING_STATUS = 0
           THEN 1 ELSE 0 END
       ) OVER (PARTITION BY  WEL1.EVENT_KEY_PARENT)  ) = 0 THEN (MAX(WH1.CLOSING_DATE) OVER (PARTITION BY WEL1.EVENT_KEY_PARENT))
END AS COMPLETION_DATE

FROM "AMOSSERVER_PROD"."WO_EVENT_LINK" WEL1

LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH1 ON DH1.DOCNO_I = WEL1.EVENT_KEY_PARENT
LEFT JOIN "AMOSSERVER_PROD"."FORECAST" F1 ON WEL1.EVENT_PERFNO_I = F1.EVENT_PERFNO_I
LEFT JOIN "AMOSSERVER_PROD"."WO_HEADER" WH1 ON WEL1.EVENT_PERFNO_I = WH1.EVENT_PERFNO_I 
WHERE DH1.DOCNO_I = DH.DOCNO_I) COMPLETION_DATE,

      WH.PRIO,
       TO_NUMBER(WH.EST_GROUNDTIME/1) AS EST_MHRS, /*MINUTES*/
       WPH.WPNO,
WPH.START_DATE AS PLANNED_DATE,

CASE
WHEN (SELECT DISTINCT

COUNT(WPDH.DEASSIGNMENT_REASON) OVER (PARTITION BY DH1.DOCNO_I)  AS SUMA

FROM "AMOSSERVER_PROD"."WP_DEASSIGNMENT_HISTORY" WPDH

INNER JOIN "AMOSSERVER_PROD"."WO_EVENT_LINK" WEL1 ON WPDH.EVENT_PERFNO_I = WEL1.EVENT_PERFNO_I
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH1 ON WEL1.EVENT_KEY_PARENT = DH1.DOCNO_I

WHERE DH1.DOCNO_I =  DH.DOCNO_I)  IS NOT NULL THEN  (SELECT DISTINCT

COUNT(WPDH.DEASSIGNMENT_REASON) OVER (PARTITION BY DH1.DOCNO_I)  AS SUMA

FROM "AMOSSERVER_PROD"."WP_DEASSIGNMENT_HISTORY" WPDH

INNER JOIN "AMOSSERVER_PROD"."WO_EVENT_LINK" WEL1 ON WPDH.EVENT_PERFNO_I = WEL1.EVENT_PERFNO_I
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH1 ON WEL1.EVENT_KEY_PARENT = DH1.DOCNO_I

WHERE DH1.DOCNO_I =  DH.DOCNO_I)  
ELSE 0

END AS NUM_OF_DEASSIGNMENTS,

SUBSTR(WPH.STATION,1,3) AS STA,
(SELECT DISTINCT A.VENDOR FROM "AMOSSERVER_PROD"."ADDRESS" A INNER JOIN "AMOSSERVER_PROD"."ORG_APPROVAL" ORG_A ON A.ADDRESS_I = ORG_A.MAIN_ADDRESS_I WHERE ORG_A.APPROVALNO_I = WH.APPROVALNO_I) AS MRO,
       CASE WHEN DH.BLOCKED_BY IN( 'ALBALM', 'XAVMOR' ,'FERFUE','POLSAB','STRUCT') THEN 'STRUCTURES' 
WHEN DH.BLOCKED_BY IN( 'JOHJAR','JASGAR','GUICON','GLORUI','VANVEL','MARJUL','SYSTEMS','AVIONIC') THEN 'SYSTEMS' 

WHEN DH.BLOCKED_BY IN( 'CRIRIB','SANMOR','ENGINES') THEN 'ENGINES' 
WHEN DH.BLOCKED_BY = 'JAUESP' THEN 'JAUME E.' 
WHEN DH.BLOCKED_BY IN( 'CARROS','VERMAR') THEN 'MAINTENANCE PROGRAM' 
WHEN DH.BLOCKED_BY IN( 'RELIAB') THEN 'RELIABILITY' 
 END AS RESPONSIBLE,

CASE


WHEN SUBSTR((SELECT DISTINCT
LISTAGG(( '{PARTNO: ' ||PRT.PARTNO || '| QTY: ' || TO_NUMBER(PRT.QTY) || '| PERC: ' || PRT.PERCENTAGE || ' % }'), '; ') 
WITHIN GROUP (ORDER BY PRT.PARTNO) OVER (PARTITION BY DH2.DOCNO_I) AS PART_REQUEST


FROM "AMOSSERVER_PROD"."DOC_HEADER" DH2
JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY_LINK" EEL ON DH2.DOCNO_I = EEL.EVENT_KEY
	AND EEL.EVENT_TYPE = 'DO'
JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY" EE ON EEL.EFFECTIVITYNO_I = EE.EFFECTIVITYNO_I
JOIN "AMOSSERVER_PROD"."WORKTEMPLATE_LINK" WTL ON WTL.EVENT_TYPE = 'EFL'
	AND EEL.EFFECTIVITY_LINKNO_I = WTL.EVENT_KEY
JOIN "AMOSSERVER_PROD"."EVENT_TEMPLATE" ET ON WTL.WTNO_I = ET.WTNO_I
	AND ET.REVISION_STATUS = 1 /*ONLY ACTIVE*/
JOIN "AMOSSERVER_PROD"."WORKSTEP_LINK" WSL ON ET.EVENT_PERFNO_I = WSL.EVENT_PERFNO_I
JOIN "AMOSSERVER_PROD"."PART_REQUEST_TEMPLATE" PRT ON WSL.DESCNO_I = PRT.EVENT_KEY
	AND PRT.EVENT_TYPE = 'WS'

WHERE LENGTH(PRT.PARTNO) > 6 AND EEL.EFFECTIVITY_LINKNO_I = (SELECT DISTINCT MIN(EEL2.EFFECTIVITY_LINKNO_I) OVER (PARTITION BY DH2.DOCNO_I) 
FROM "AMOSSERVER_PROD"."EVENT_EFFECTIVITY_LINK" EEL2 WHERE DH2.DOCNO_I = EEL2.EVENT_KEY) AND DH2.DOCNO_I =  DH.DOCNO_I ), 1, 200) IS NOT NULL THEN SUBSTR((SELECT DISTINCT
LISTAGG(( '{PARTNO: ' ||PRT.PARTNO || '| QTY: ' || TO_NUMBER(PRT.QTY) || '| PERC: ' || PRT.PERCENTAGE || ' % }'), '; ') 
WITHIN GROUP (ORDER BY PRT.PARTNO) OVER (PARTITION BY DH2.DOCNO_I) AS PART_REQUEST


FROM "AMOSSERVER_PROD"."DOC_HEADER" DH2
JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY_LINK" EEL ON DH2.DOCNO_I = EEL.EVENT_KEY
	AND EEL.EVENT_TYPE = 'DO'
JOIN "AMOSSERVER_PROD"."EVENT_EFFECTIVITY" EE ON EEL.EFFECTIVITYNO_I = EE.EFFECTIVITYNO_I
JOIN "AMOSSERVER_PROD"."WORKTEMPLATE_LINK" WTL ON WTL.EVENT_TYPE = 'EFL'
	AND EEL.EFFECTIVITY_LINKNO_I = WTL.EVENT_KEY
JOIN "AMOSSERVER_PROD"."EVENT_TEMPLATE" ET ON WTL.WTNO_I = ET.WTNO_I
	AND ET.REVISION_STATUS = 1 /*ONLY ACTIVE*/
JOIN "AMOSSERVER_PROD"."WORKSTEP_LINK" WSL ON ET.EVENT_PERFNO_I = WSL.EVENT_PERFNO_I
JOIN "AMOSSERVER_PROD"."PART_REQUEST_TEMPLATE" PRT ON WSL.DESCNO_I = PRT.EVENT_KEY
	AND PRT.EVENT_TYPE = 'WS'

WHERE LENGTH(PRT.PARTNO) > 6 AND EEL.EFFECTIVITY_LINKNO_I = (SELECT DISTINCT MIN(EEL2.EFFECTIVITY_LINKNO_I) OVER (PARTITION BY DH2.DOCNO_I) 
FROM "AMOSSERVER_PROD"."EVENT_EFFECTIVITY_LINK" EEL2 WHERE DH2.DOCNO_I = EEL2.EVENT_KEY) AND DH2.DOCNO_I =  DH.DOCNO_I ), 1, 200)

WHEN SUBSTR((SELECT DISTINCT

LISTAGG(( '{PARTNO: ' ||PRT.PARTNO || '| QTY: ' || TO_NUMBER(PRT.QTY) || '| PERC: ' || PRT.PERCENTAGE || ' % }'), '; ') 
WITHIN GROUP (ORDER BY PRT.PARTNO) OVER (PARTITION BY DH2.DOCNO_I) AS PART_REQUEST
FROM "AMOSSERVER_PROD"."DOC_HEADER" DH2
JOIN "AMOSSERVER_PROD"."REQUIREMENT_HEADER" RH ON DH2.DOCNO_I = RH.EVENT_KEY
	AND RH.EVENT_TYPE = 'DO'
JOIN "AMOSSERVER_PROD"."WORKTEMPLATE_LINK" WTL ON RH.REQUIREMENT_HEADERNO_I= WTL.EVENT_KEY
	AND WTL.EVENT_TYPE = 'REQH'
JOIN "AMOSSERVER_PROD"."EVENT_TEMPLATE" ET ON WTL.WTNO_I = ET.WTNO_I
	AND ET.REVISION_STATUS = 1 /*ONLY ACTIVE*/
JOIN "AMOSSERVER_PROD"."WORKSTEP_LINK" WSL ON ET.EVENT_PERFNO_I = WSL.EVENT_PERFNO_I
JOIN "AMOSSERVER_PROD"."PART_REQUEST_TEMPLATE" PRT ON WSL.DESCNO_I = PRT.EVENT_KEY
	AND PRT.EVENT_TYPE = 'WS'
WHERE  LENGTH(PRT.PARTNO) > 6 AND DH2.DOCNO_I = DH.DOCNO_I),1,200) IS NOT NULL THEN  SUBSTR((SELECT DISTINCT

LISTAGG(( '{PARTNO: ' ||PRT.PARTNO || '| QTY: ' || TO_NUMBER(PRT.QTY) || '| PERC: ' || PRT.PERCENTAGE || ' % }'), '; ') 
WITHIN GROUP (ORDER BY PRT.PARTNO) OVER (PARTITION BY DH2.DOCNO_I) AS PART_REQUEST
FROM "AMOSSERVER_PROD"."DOC_HEADER" DH2
JOIN "AMOSSERVER_PROD"."REQUIREMENT_HEADER" RH ON DH2.DOCNO_I = RH.EVENT_KEY
	AND RH.EVENT_TYPE = 'DO'
JOIN "AMOSSERVER_PROD"."WORKTEMPLATE_LINK" WTL ON RH.REQUIREMENT_HEADERNO_I= WTL.EVENT_KEY
	AND WTL.EVENT_TYPE = 'REQH'
JOIN "AMOSSERVER_PROD"."EVENT_TEMPLATE" ET ON WTL.WTNO_I = ET.WTNO_I
	AND ET.REVISION_STATUS = 1 /*ONLY ACTIVE*/
JOIN "AMOSSERVER_PROD"."WORKSTEP_LINK" WSL ON ET.EVENT_PERFNO_I = WSL.EVENT_PERFNO_I
JOIN "AMOSSERVER_PROD"."PART_REQUEST_TEMPLATE" PRT ON WSL.DESCNO_I = PRT.EVENT_KEY
	AND PRT.EVENT_TYPE = 'WS'
WHERE  LENGTH(PRT.PARTNO) > 6 AND DH2.DOCNO_I = DH.DOCNO_I),1,200)

ELSE 'N/A'

END AS PART_REQUEST,

CURRENT_DATE AS CURR_DATE     

FROM "AMOSSERVER_PROD"."WO_EVENT_LINK" WEL
LEFT JOIN "AMOSSERVER_PROD"."WO_HEADER" WH  ON WEL.EVENT_PERFNO_I = WH.EVENT_PERFNO_I    
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER" DH ON  WEL.EVENT_KEY_PARENT = DH.DOCNO_I    
LEFT JOIN "AMOSSERVER_PROD"."FORECAST" F ON WH.EVENT_PERFNO_I = F.EVENT_PERFNO_I   
LEFT JOIN "AMOSSERVER_PROD"."WP_ASSIGNMENT" WPA ON WH.EVENT_PERFNO_I = WPA.EVENT_PERFNO_I 
LEFT JOIN "AMOSSERVER_PROD"."WP_HEADER" WPH ON WPA.WPNO_I = WPH.WPNO_I 
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER_CLASSIFICATION" DHC ON DH.DOCNO_I = DHC.DOCNO_I    
LEFT JOIN "AMOSSERVER_PROD"."DOC_HEADER_MORE" DHM ON DH.DOCNO_I = DHM.DOCNO_I 
LEFT JOIN "AMOSSERVER_PROD"."DEPARTMENT" D ON DHM.REQ_DEPARTMENT = D.DEPARTMENT  

LEFT JOIN "AMOSSERVER_PROD"."AIRCRAFT" A ON WH.AC_REGISTR = A.AC_REGISTR

WHERE  A.STATUS = 0      
      AND WEL.EVENT_STATUS IN(
         'O',
         'C',
         'V',
         'Y' 
      )       
      AND DHC.CLASSIFICATION = 'CAMP' 
      AND (
         WH.CLOSING_DATE IS NOT NULL 
         OR  (
            WEL.EVENT_STATUS IN(
               'Y' ,
               'O'
            ) 
            AND WH.CLOSING_DATE IS NULL 
            AND F.EXPECTED_DATE <  24838 
            AND F.EXPECTED_DATE IS NOT NULL 
         ) AND F.EVENT_TYPE = 'D'
      ) 	  
ORDER BY  DUE_DATE
